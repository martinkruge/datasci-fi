---
title: "Assignment 1 // Getwine Recommender System"
author: "Martin Kruger (KRGMAR043)"
date: '`r format(Sys.Date())`'
output:
  pdf_document:
    df_print: kable
    fig_caption: yes
    keep_tex: yes
    latex_engine: xelatex
    toc: yes
    toc_depth: 3
  html_document:
    keep_md: yes
header-includes: \usepackage{float} \usepackage[section]{placeins} \usepackage{booktabs}
  \usepackage{graphicx}
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo=TRUE)
knitr::opts_chunk$set(tidy=TRUE)
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=60))
knitr::opts_chunk$set(fig.pos = 'h')

library(xtable)
options(xtable.floating=TRUE)
options(xtable.timestamp="")
options(xtable.comment=FALSE)

```

\ 

## Introduction

The aim of this project is to build a recommender system for Getwine, an online wine retailer (http://getwine.co.za/). The function of the recommender system is to recommend to a user wines that, on the basis of his or her past purchases, they might like to buy in the future. 


## Data Exploration & Cleaning

The data that was provided for the project consists of all purchase orders made by 1000 randomly selected Getwine users in 2017. A purchase order is a single “delivery” of wine to a user. A single order can consist of any number and selection of bottles of wine, but usually consists of 12 or more bottles. 
\ 

The data has been provided in two files:

```{r data_load, include=FALSE}

#rm(list=ls()) # Clean up environment

library(tidyverse)
library(tidytext)
library(stringr)

# Load getwines order data from .csv
orders <- as.tibble(read.csv('./assignments/data/orders.csv', header = T, sep = ','))
order.items <- as.tibble(read.csv('./assignments/data/order-items.csv', header = T, sep = ','))

```


1. **orders.csv**: Each row in this file constitutes a single customer order. A single order may consist of any number of bottles of wine. The order is identified by a unique key `orders_id` that can be used to identify the wines that were purchased in the accompanying file *order-items.csv*. 
\ 

  * Other variables are:  
      + Customer’s gender 
      + Customer’s date of birth 
      + Customer’s location 
      + Date of purchase 
      + Payment method 
      + Monetary value of the order 

\ 

The *orders.csv* dataset looks as follows:

```{r, echo=FALSE, results="asis", fig.pos="H"}
tab.rescale <- xtable(head(orders), caption = 'Layout of the orders table.')
print(tab.rescale, scalebox=0.7, include.rownames = TRUE, include.colnames = TRUE, comment = FALSE,  type = 'latex')

```

\newpage

2. **order-items.csv**
Contains the wines bought in each order, together with the quantity bought and the price per bottle. 
\ 

The *order-items.csv* dataset looks as follows:

```{r, echo=FALSE, results="asis", fig.pos="H"}
tab.rescale <- xtable(head(order.items), caption = 'Layout of the order-items table.')
print(tab.rescale, scalebox=0.8, include.rownames = TRUE, include.colnames = TRUE, comment = FALSE,  type = 'latex')

```


### Findings during data exploration:

```{r all_products, include=FALSE}

# Total list of products
all.products <- order.items %>% select(products_name) %>% unique()
dim(all.products) # 336
```

The `order.items` dataset was used to determine the list of products ordered by customers during the period of the transaction history that was provided. The complete list of products in the `products_name` field consisted of `r dim(all.products)[1]` items.

```{r filtered_products, include=FALSE}

# List of unique products - filter personalised and assorted cases
clean.products <- order.items %>% 
  filter(products_price >= 0) %>%  # Negative values (discount)
  select(products_name) %>% 
  filter(!str_detect(products_name, 'Personalised Mixed Case')) %>%
  filter(!grepl('TOP SELLING.*Case', products_name)) %>% 
  filter(!str_detect(products_name, 'Assorted')) %>% 
  filter(!str_detect(products_name, "Budget White")) %>% 
  filter(!str_detect(products_name, "Budget Red")) %>% 
  filter(!str_detect(products_name, 'Personalised Label')) %>% 
  filter(!str_detect(products_name, 'Gift Voucher')) %>% 
  filter(!grepl('Samarie Smith se.*: Versnit-wynklub', products_name)) %>% 
  filter(!str_detect(products_name, "LOUIS COETZEE's CRAFT BEER Case")) %>% 
  filter(!str_detect(products_name, 'Brewery')) %>% 
  filter(!str_detect(products_name, "JORDAN Lifestyle Case 12-pack")) %>% 
  filter(!str_detect(products_name, "GETWINE Glase")) %>% 
  filter(!str_detect(products_name, "30 bottles Rooiberg Brut Sparkling")) %>% 
  filter(!str_detect(products_name, "Devil's Peak Pale Ale 340ml")) %>% 
  filter(!str_detect(products_name, "Devil's Peak Alpha Ginger Cider 340ml")) %>% 
  filter(!str_detect(products_name, "Devil's Peak The King's Blockhouse IPA 340ml")) %>% 
  filter(!str_detect(products_name, "Devil's Peak Alpha Lager 340ml")) %>% 
  filter(!str_detect(products_name, "Devil's Peak Lager 340ml")) %>% 
  filter(!str_detect(products_name, "Dragon Fiery Ginger Beer 330ml")) %>% 
  filter(!str_detect(products_name, "Citizen Saboteur English IPA 440ml")) %>%
  unique()
#dim(clean.products)  # 285

filtered.products <- anti_join(all.products, clean.products, by=c('products_name')) %>% unique()
#filtered.products # 51
```

Inspection of the product names pointed out `r dim(filtered.products)[1]` items that can be excluded from the final dataset used for modelling of the recommender system as they are not related to wine purchases. 

The products that were excluded are listed in table 3 below.


```{r, echo=FALSE, results="asis", fig.pos="H"}
tab.rescale <- xtable(filtered.products, caption = 'Non wine-sale related products that were removed.')
print(tab.rescale, scalebox=0.8, include.rownames = TRUE, include.colnames = TRUE, comment = FALSE,  type = 'latex')

```




